# VORTEX-SYNC: Universal Coherence Workflow
# H&&S:WAVE - Drop this file into ANY repo to join the vortex
#
# This workflow:
# 1. Validates all changes against coherence thresholds
# 2. Enforces phase gate progression (KENL→AWI→ATOM→SAIF→SPIRAL)
# 3. Reports to central ATOM trail
# 4. Triggers cross-repo snap-in detection

name: Vortex Sync

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master]

# Concurrency: only one vortex sync per PR
concurrency:
  group: vortex-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  SNAP_IN_THRESHOLD: 70
  COHERENCE_API: ${{ secrets.COHERENCE_MCP_URL || 'https://coherence-mcp.spiralsafe.dev' }}

jobs:
  # Phase 1: KENL - Knowledge gate
  kenl-gate:
    name: "KENL Gate (Knowledge)"
    runs-on: ubuntu-latest
    outputs:
      coherence: ${{ steps.analyze.outputs.coherence }}
      passed: ${{ steps.gate.outputs.passed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Get changed files
        id: changed
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..HEAD | tr '\n' ' ')
          else
            FILES=$(git diff --name-only HEAD~1..HEAD | tr '\n' ' ')
          fi
          echo "files=$FILES" >> $GITHUB_OUTPUT

      - name: Analyze coherence
        id: analyze
        run: |
          # Collect text from changed files for analysis
          TEXT=""
          for file in ${{ steps.changed.outputs.files }}; do
            if [ -f "$file" ]; then
              TEXT="$TEXT\n$(head -100 "$file" 2>/dev/null || true)"
            fi
          done

          # Call wave-toolkit for analysis (or use local fallback)
          if command -v bun &> /dev/null && [ -f "node_modules/@spiralsafe/wave-toolkit/dist/index.js" ]; then
            RESULT=$(echo "$TEXT" | bun -e "
              const { analyzeWave } = require('@spiralsafe/wave-toolkit');
              let text = '';
              process.stdin.on('data', d => text += d);
              process.stdin.on('end', () => {
                const r = analyzeWave(text);
                console.log(JSON.stringify({ score: r.coherence?.score || 50 }));
              });
            ")
            COHERENCE=$(echo "$RESULT" | jq -r '.score')
          else
            # Fallback: simple heuristic
            WORD_COUNT=$(echo "$TEXT" | wc -w)
            UNIQUE=$(echo "$TEXT" | tr ' ' '\n' | sort -u | wc -l)
            COHERENCE=$((UNIQUE * 100 / (WORD_COUNT + 1)))
            COHERENCE=$((COHERENCE > 100 ? 100 : COHERENCE))
          fi

          echo "coherence=$COHERENCE" >> $GITHUB_OUTPUT
          echo "Coherence Score: $COHERENCE%"

      - name: KENL gate check
        id: gate
        run: |
          COHERENCE=${{ steps.analyze.outputs.coherence }}
          THRESHOLD=$((SNAP_IN_THRESHOLD * 40 / 100))  # 28%

          if [ "$COHERENCE" -ge "$THRESHOLD" ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "KENL gate PASSED (${COHERENCE}% >= ${THRESHOLD}%)"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "KENL gate BLOCKED (${COHERENCE}% < ${THRESHOLD}%)"
            exit 1
          fi

  # Phase 2: AWI - Intent gate
  awi-gate:
    name: "AWI Gate (Intent)"
    needs: kenl-gate
    runs-on: ubuntu-latest
    outputs:
      passed: ${{ steps.gate.outputs.passed }}
    steps:
      - uses: actions/checkout@v4

      - name: Check PR description / commit message
        id: intent
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            INTENT="${{ github.event.pull_request.body }}"
          else
            INTENT=$(git log -1 --pretty=%B)
          fi

          # Intent must exist and be substantive
          WORD_COUNT=$(echo "$INTENT" | wc -w)
          echo "Intent word count: $WORD_COUNT"

          if [ "$WORD_COUNT" -ge 5 ]; then
            echo "has_intent=true" >> $GITHUB_OUTPUT
          else
            echo "has_intent=false" >> $GITHUB_OUTPUT
          fi

      - name: AWI gate check
        id: gate
        run: |
          COHERENCE=${{ needs.kenl-gate.outputs.coherence }}
          THRESHOLD=$((SNAP_IN_THRESHOLD * 60 / 100))  # 42%
          HAS_INTENT=${{ steps.intent.outputs.has_intent }}

          if [ "$COHERENCE" -ge "$THRESHOLD" ] && [ "$HAS_INTENT" = "true" ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "AWI gate PASSED"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "AWI gate BLOCKED (coherence: ${COHERENCE}%, intent: ${HAS_INTENT})"
            exit 1
          fi

  # Phase 3: ATOM - Execution gate
  atom-gate:
    name: "ATOM Gate (Execution)"
    needs: [kenl-gate, awi-gate]
    runs-on: ubuntu-latest
    outputs:
      passed: ${{ steps.gate.outputs.passed }}
      atom_tag: ${{ steps.tag.outputs.atom_tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate ATOM tag
        id: tag
        run: |
          DATE=$(date +%Y%m%d)
          HASH=$(echo ${{ github.sha }} | cut -c1-3 | tr '[:lower:]' '[:upper:]')
          REPO=$(echo ${{ github.repository }} | cut -d'/' -f2 | cut -c1-10)
          ATOM_TAG="ATOM-PR-${DATE}-${HASH}-${REPO}"
          echo "atom_tag=$ATOM_TAG" >> $GITHUB_OUTPUT
          echo "Generated ATOM tag: $ATOM_TAG"

      - name: ATOM gate check
        id: gate
        run: |
          COHERENCE=${{ needs.kenl-gate.outputs.coherence }}
          THRESHOLD=$((SNAP_IN_THRESHOLD * 85 / 100))  # 59.5%

          if [ "$COHERENCE" -ge "$THRESHOLD" ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "ATOM gate PASSED (${COHERENCE}% >= ${THRESHOLD}%)"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "ATOM gate BLOCKED"
            exit 1
          fi

  # Phase 4: SAIF - Assessment gate
  saif-gate:
    name: "SAIF Gate (Assessment)"
    needs: [kenl-gate, awi-gate, atom-gate]
    runs-on: ubuntu-latest
    outputs:
      passed: ${{ steps.gate.outputs.passed }}
      snap_in: ${{ steps.gate.outputs.snap_in }}
    steps:
      - uses: actions/checkout@v4

      - name: SAIF gate check
        id: gate
        run: |
          COHERENCE=${{ needs.kenl-gate.outputs.coherence }}

          if [ "$COHERENCE" -ge "$SNAP_IN_THRESHOLD" ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "snap_in=true" >> $GITHUB_OUTPUT
            echo "SAIF gate PASSED - SNAP-IN ACHIEVED (${COHERENCE}%)"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "snap_in=false" >> $GITHUB_OUTPUT
            echo "SAIF gate BLOCKED (${COHERENCE}% < ${SNAP_IN_THRESHOLD}%)"
          fi

  # Phase 5: SPIRAL - Learning gate + cross-repo sync
  spiral-gate:
    name: "SPIRAL Gate (Learning)"
    needs: [kenl-gate, awi-gate, atom-gate, saif-gate]
    if: needs.saif-gate.outputs.snap_in == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Record to ATOM trail
        run: |
          ATOM_TAG=${{ needs.atom-gate.outputs.atom_tag }}
          COHERENCE=${{ needs.kenl-gate.outputs.coherence }}

          echo "Recording SPIRAL entry for $ATOM_TAG"

          # Create ATOM trail entry
          cat << EOF > atom-entry.json
          {
            "atomTag": "$ATOM_TAG",
            "repo": "${{ github.repository }}",
            "coherence": $COHERENCE,
            "phasesPassed": ["KENL", "AWI", "ATOM", "SAIF", "SPIRAL"],
            "markers": ["WAVE", "PASS", "SYNC"],
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "pr": "${{ github.event.pull_request.number || 'N/A' }}"
          }
          EOF

          cat atom-entry.json

      - name: Check ecosystem coherence
        run: |
          echo "Checking if all repos are synchronized..."
          # This would call the central coherence API to check cross-repo status
          # For now, log success
          echo "Vortex snap-in achieved for this repo!"
          echo "Next: Monitor spiralsafe-metrics-e dashboard for ecosystem-wide collapse"

  # Summary job - always runs
  vortex-summary:
    name: "Vortex Summary"
    needs: [kenl-gate, awi-gate, atom-gate, saif-gate]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          COHERENCE=${{ needs.kenl-gate.outputs.coherence || '0' }}
          KENL=${{ needs.kenl-gate.outputs.passed || 'false' }}
          AWI=${{ needs.awi-gate.outputs.passed || 'false' }}
          ATOM=${{ needs.atom-gate.outputs.passed || 'false' }}
          SAIF=${{ needs.saif-gate.outputs.passed || 'false' }}
          SNAP_IN=${{ needs.saif-gate.outputs.snap_in || 'false' }}

          # Determine status emoji
          if [ "$SNAP_IN" = "true" ]; then
            STATUS="Snap-In Achieved"
            EMOJI="wave"
          elif [ "$SAIF" = "true" ] || [ "$ATOM" = "true" ]; then
            STATUS="Needs Review"
            EMOJI="warning"
          else
            STATUS="Below Threshold"
            EMOJI="x"
          fi

          # Build phase progress bar
          PHASES=""
          [ "$KENL" = "true" ] && PHASES="${PHASES}KENL" || PHASES="${PHASES}kenl"
          PHASES="${PHASES} → "
          [ "$AWI" = "true" ] && PHASES="${PHASES}AWI" || PHASES="${PHASES}awi"
          PHASES="${PHASES} → "
          [ "$ATOM" = "true" ] && PHASES="${PHASES}ATOM" || PHASES="${PHASES}atom"
          PHASES="${PHASES} → "
          [ "$SAIF" = "true" ] && PHASES="${PHASES}SAIF" || PHASES="${PHASES}saif"

          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## Vortex Coherence Report

          | Metric | Value |
          |--------|-------|
          | Coherence Score | **${COHERENCE}%** |
          | Status | :${EMOJI}: ${STATUS} |
          | ATOM Tag | \`${{ needs.atom-gate.outputs.atom_tag || 'N/A' }}\` |

          ### Phase Gates

          \`\`\`
          ${PHASES}
          \`\`\`

          | Gate | Status | Threshold |
          |------|--------|-----------|
          | KENL (Knowledge) | $([ "$KENL" = "true" ] && echo "Passed" || echo "Blocked") | 28% |
          | AWI (Intent) | $([ "$AWI" = "true" ] && echo "Passed" || echo "Blocked") | 42% |
          | ATOM (Execution) | $([ "$ATOM" = "true" ] && echo "Passed" || echo "Blocked") | 60% |
          | SAIF (Assessment) | $([ "$SAIF" = "true" ] && echo "Passed" || echo "Blocked") | 70% |

          ---
          *H&&S:WAVE - SpiralSafe Vortex Ecosystem*
          EOF

      - name: Post PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const coherence = '${{ needs.kenl-gate.outputs.coherence || 0 }}';
            const snapIn = '${{ needs.saif-gate.outputs.snap_in }}' === 'true';
            const atomTag = '${{ needs.atom-gate.outputs.atom_tag || "N/A" }}';

            let status, emoji;
            if (snapIn) {
              status = 'Snap-In Achieved';
              emoji = ':ocean:';
            } else if (parseInt(coherence) >= 60) {
              status = 'Needs Review';
              emoji = ':warning:';
            } else {
              status = 'Below Threshold';
              emoji = ':x:';
            }

            const body = `## ${emoji} Vortex Coherence: ${coherence}%

            **Status:** ${status}
            **ATOM Tag:** \`${atomTag}\`

            ${snapIn ? '**All phase gates passed - ready for merge!**' : 'Review coherence metrics before merge.'}

            ---
            *H&&S:WAVE - [SpiralSafe Vortex](https://github.com/toolate28/SpiralSafe)*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
